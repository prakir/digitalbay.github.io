{"version":3,"file":"preprocessors.js","sources":["../../src/preprocessors.ts"],"sourcesContent":["import MagicString from 'magic-string';\nimport type { PreprocessorGroup } from 'svelte/types/compiler/preprocess';\nimport type { ComponentTrackingInitOptions, SentryPreprocessorGroup, TrackComponentOptions } from './types';\n\nexport const defaultComponentTrackingOptions: Required<ComponentTrackingInitOptions> = {\n  trackComponents: true,\n  trackInit: true,\n  trackUpdates: false,\n};\n\nexport const FIRST_PASS_COMPONENT_TRACKING_PREPROC_ID = 'FIRST_PASS_COMPONENT_TRACKING_PREPROCESSOR';\n\n/**\n * Svelte Preprocessor to inject Sentry performance monitoring related code\n * into Svelte components.\n */\nexport function componentTrackingPreprocessor(options?: ComponentTrackingInitOptions): PreprocessorGroup {\n  const mergedOptions = { ...defaultComponentTrackingOptions, ...options };\n\n  const visitedFiles = new Set<string>();\n  const visitedFilesMarkup = new Set<string>();\n\n  const preprocessor: PreprocessorGroup = {\n    // This markup hook is called once per .svelte component file, before the `script` hook is called\n    // We use it to check if the passed component has a <script> tag. If it doesn't, we add one to inject our\n    // code later on, when the `script` hook is executed.\n    markup: ({ content, filename }) => {\n      const finalFilename = filename || 'unknown';\n      const shouldInject = shouldInjectFunction(mergedOptions.trackComponents, finalFilename, {}, visitedFilesMarkup);\n\n      if (shouldInject && !hasScriptTag(content)) {\n        // Insert a <script> tag into the component file where we can later on inject our code.\n        // We have to add a placeholder to the script tag because for empty script tags,\n        // the `script` preprocessor hook won't be called\n        // Note: The space between <script> and </script> is important! Without any content,\n        // the `script` hook wouldn't  be executed for the added script tag.\n        const s = new MagicString(content);\n        s.prepend('<script>\\n</script>\\n');\n        return { code: s.toString(), map: s.generateMap().toString() };\n      }\n\n      return { code: content };\n    },\n\n    // This script hook is called whenever a Svelte component's <script> content is preprocessed.\n    // `content` contains the script code as a string\n    script: ({ content, filename, attributes }) => {\n      // TODO: Not sure when a filename could be undefined. Using this 'unknown' fallback for the time being\n      const finalFilename = filename || 'unknown';\n\n      if (!shouldInjectFunction(mergedOptions.trackComponents, finalFilename, attributes, visitedFiles)) {\n        return { code: content };\n      }\n\n      const { trackInit, trackUpdates } = mergedOptions;\n      const trackComponentOptions: TrackComponentOptions = {\n        trackInit,\n        trackUpdates,\n        componentName: getBaseName(finalFilename),\n      };\n\n      const importStmt = 'import { trackComponent } from \"@sentry/svelte\";\\n';\n      const functionCall = `trackComponent(${JSON.stringify(trackComponentOptions)});\\n`;\n\n      const s = new MagicString(content);\n      s.prepend(functionCall).prepend(importStmt);\n\n      const updatedCode = s.toString();\n      const updatedSourceMap = s.generateMap().toString();\n\n      return { code: updatedCode, map: updatedSourceMap };\n    },\n  };\n\n  const sentryPreprocessor: SentryPreprocessorGroup = {\n    ...preprocessor,\n    sentryId: FIRST_PASS_COMPONENT_TRACKING_PREPROC_ID,\n  };\n\n  return sentryPreprocessor;\n}\n\nfunction shouldInjectFunction(\n  trackComponents: Required<ComponentTrackingInitOptions['trackComponents']>,\n  filename: string,\n  attributes: Record<string, string | boolean>,\n  visitedFiles: Set<string>,\n): boolean {\n  // We do cannot inject our function multiple times into the same component\n  // This can happen when a component has multiple <script> blocks\n  if (visitedFiles.has(filename)) {\n    return false;\n  }\n  visitedFiles.add(filename);\n\n  // We can't inject our function call into <script context=\"module\"> blocks\n  // because the code inside is not executed when the component is instantiated but\n  // when the module is first imported.\n  // see: https://svelte.dev/docs#component-format-script-context-module\n  if (attributes.module || attributes.context === 'module') {\n    return false;\n  }\n\n  if (!trackComponents) {\n    return false;\n  }\n\n  if (Array.isArray(trackComponents)) {\n    const componentName = getBaseName(filename);\n    return trackComponents.some(allowed => allowed === componentName);\n  }\n\n  return true;\n}\n\nfunction getBaseName(filename: string): string {\n  const segments = filename.split('/');\n  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n  return segments[segments.length - 1]!.replace('.svelte', '');\n}\n\nfunction hasScriptTag(content: string): boolean {\n  // This regex is taken from the Svelte compiler code.\n  // They use this regex to find matching script tags that are passed to the `script` preprocessor hook:\n  // https://github.com/sveltejs/svelte/blob/bb83eddfc623437528f24e9fe210885b446e72fa/src/compiler/preprocess/index.ts#L144\n  // However, we remove the first part of the regex to not match HTML comments\n  const scriptTagRegex = /<script(\\s[^]*?)?(?:>([^]*?)<\\/script\\s*>|\\/>)/gi;\n\n  // Regex testing is not a super safe way of checking for the presence of a <script> tag in the Svelte\n  // component file but I think we can use it as a start.\n  // A case that is not covered by regex-testing HTML is e.g. nested <script> tags but I cannot\n  // think of why one would do this in Svelte components. For instance, the Svelte compiler errors\n  // when there's more than one top-level script tag.\n  return scriptTagRegex.test(content);\n}\n"],"names":["MagicString"],"mappings":";;;;AAIO,MAAM,+BAA+B,GAA2C;AACvF,EAAE,eAAe,EAAE,IAAI;AACvB,EAAE,SAAS,EAAE,IAAI;AACjB,EAAE,YAAY,EAAE,KAAK;AACrB;;AAEO,MAAM,wCAAA,GAA2C;;AAExD;AACA;AACA;AACA;AACO,SAAS,6BAA6B,CAAC,OAAO,EAAoD;AACzG,EAAE,MAAM,gBAAgB,EAAE,GAAG,+BAA+B,EAAE,GAAG,OAAA,EAAS;;AAE1E,EAAE,MAAM,YAAA,GAAe,IAAI,GAAG,EAAU;AACxC,EAAE,MAAM,kBAAA,GAAqB,IAAI,GAAG,EAAU;;AAE9C,EAAE,MAAM,YAAY,GAAsB;AAC1C;AACA;AACA;AACA,IAAI,MAAM,EAAE,CAAC,EAAE,OAAO,EAAE,QAAA,EAAU,KAAK;AACvC,MAAM,MAAM,aAAA,GAAgB,QAAA,IAAY,SAAS;AACjD,MAAM,MAAM,YAAA,GAAe,oBAAoB,CAAC,aAAa,CAAC,eAAe,EAAE,aAAa,EAAE,EAAE,EAAE,kBAAkB,CAAC;;AAErH,MAAM,IAAI,YAAA,IAAgB,CAAC,YAAY,CAAC,OAAO,CAAC,EAAE;AAClD;AACA;AACA;AACA;AACA;AACA,QAAQ,MAAM,CAAA,GAAI,IAAIA,mBAAW,CAAC,OAAO,CAAC;AAC1C,QAAQ,CAAC,CAAC,OAAO,CAAC,uBAAuB,CAAC;AAC1C,QAAQ,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC,QAAQ,EAAE,EAAE,GAAG,EAAE,CAAC,CAAC,WAAW,EAAE,CAAC,QAAQ,EAAC,EAAG;AACtE;;AAEA,MAAM,OAAO,EAAE,IAAI,EAAE,SAAS;AAC9B,KAAK;;AAEL;AACA;AACA,IAAI,MAAM,EAAE,CAAC,EAAE,OAAO,EAAE,QAAQ,EAAE,UAAA,EAAY,KAAK;AACnD;AACA,MAAM,MAAM,aAAA,GAAgB,QAAA,IAAY,SAAS;;AAEjD,MAAM,IAAI,CAAC,oBAAoB,CAAC,aAAa,CAAC,eAAe,EAAE,aAAa,EAAE,UAAU,EAAE,YAAY,CAAC,EAAE;AACzG,QAAQ,OAAO,EAAE,IAAI,EAAE,SAAS;AAChC;;AAEA,MAAM,MAAM,EAAE,SAAS,EAAE,YAAA,EAAa,GAAI,aAAa;AACvD,MAAM,MAAM,qBAAqB,GAA0B;AAC3D,QAAQ,SAAS;AACjB,QAAQ,YAAY;AACpB,QAAQ,aAAa,EAAE,WAAW,CAAC,aAAa,CAAC;AACjD,OAAO;;AAEP,MAAM,MAAM,UAAA,GAAa,oDAAoD;AAC7E,MAAM,MAAM,YAAA,GAAe,CAAC,eAAe,EAAE,IAAI,CAAC,SAAS,CAAC,qBAAqB,CAAC,CAAC,IAAI,CAAC;;AAExF,MAAM,MAAM,CAAA,GAAI,IAAIA,mBAAW,CAAC,OAAO,CAAC;AACxC,MAAM,CAAC,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,OAAO,CAAC,UAAU,CAAC;;AAEjD,MAAM,MAAM,WAAA,GAAc,CAAC,CAAC,QAAQ,EAAE;AACtC,MAAM,MAAM,gBAAA,GAAmB,CAAC,CAAC,WAAW,EAAE,CAAC,QAAQ,EAAE;;AAEzD,MAAM,OAAO,EAAE,IAAI,EAAE,WAAW,EAAE,GAAG,EAAE,gBAAA,EAAkB;AACzD,KAAK;AACL,GAAG;;AAEH,EAAE,MAAM,kBAAkB,GAA4B;AACtD,IAAI,GAAG,YAAY;AACnB,IAAI,QAAQ,EAAE,wCAAwC;AACtD,GAAG;;AAEH,EAAE,OAAO,kBAAkB;AAC3B;;AAEA,SAAS,oBAAoB;AAC7B,EAAE,eAAe;AACjB,EAAE,QAAQ;AACV,EAAE,UAAU;AACZ,EAAE,YAAY;AACd,EAAW;AACX;AACA;AACA,EAAE,IAAI,YAAY,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE;AAClC,IAAI,OAAO,KAAK;AAChB;AACA,EAAE,YAAY,CAAC,GAAG,CAAC,QAAQ,CAAC;;AAE5B;AACA;AACA;AACA;AACA,EAAE,IAAI,UAAU,CAAC,MAAA,IAAU,UAAU,CAAC,OAAA,KAAY,QAAQ,EAAE;AAC5D,IAAI,OAAO,KAAK;AAChB;;AAEA,EAAE,IAAI,CAAC,eAAe,EAAE;AACxB,IAAI,OAAO,KAAK;AAChB;;AAEA,EAAE,IAAI,KAAK,CAAC,OAAO,CAAC,eAAe,CAAC,EAAE;AACtC,IAAI,MAAM,aAAA,GAAgB,WAAW,CAAC,QAAQ,CAAC;AAC/C,IAAI,OAAO,eAAe,CAAC,IAAI,CAAC,WAAW,OAAA,KAAY,aAAa,CAAC;AACrE;;AAEA,EAAE,OAAO,IAAI;AACb;;AAEA,SAAS,WAAW,CAAC,QAAQ,EAAkB;AAC/C,EAAE,MAAM,WAAW,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC;AACtC;AACA,EAAE,OAAO,QAAQ,CAAC,QAAQ,CAAC,MAAA,GAAS,CAAC,CAAC,CAAE,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC;AAC9D;;AAEA,SAAS,YAAY,CAAC,OAAO,EAAmB;AAChD;AACA;AACA;AACA;AACA,EAAE,MAAM,cAAA,GAAiB,kDAAkD;;AAE3E;AACA;AACA;AACA;AACA;AACA,EAAE,OAAO,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC;AACrC;;;;;;"}