{"version":3,"file":"CallMembership.js","names":["_utils","require","CallMembership","equal","a","b","deepCompare","data","constructor","parentEvent","expires","expires_ts","Error","device_id","call_id","scope","getSender","sender","callId","deviceId","application","membershipID","createdTs","_this$data$created_ts","created_ts","getTs","getAbsoluteExpiry","getLocalExpiry","relativeCreationTime","localCreationTs","localTimestamp","getMsUntilExpiry","Date","now","isExpired","getActiveFoci","_this$data$foci_activ","foci_active","exports"],"sources":["../../src/matrixrtc/CallMembership.ts"],"sourcesContent":["/*\nCopyright 2023 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MatrixEvent } from \"../matrix\";\nimport { deepCompare } from \"../utils\";\nimport { Focus } from \"./focus\";\n\ntype CallScope = \"m.room\" | \"m.user\";\n\n// Represents an entry in the memberships section of an m.call.member event as it is on the wire\nexport interface CallMembershipData {\n    application?: string;\n    call_id: string;\n    scope: CallScope;\n    device_id: string;\n    created_ts?: number;\n    expires?: number;\n    expires_ts?: number;\n    foci_active?: Focus[];\n    membershipID: string;\n}\n\nexport class CallMembership {\n    public static equal(a: CallMembership, b: CallMembership): boolean {\n        return deepCompare(a.data, b.data);\n    }\n\n    public constructor(\n        private parentEvent: MatrixEvent,\n        private data: CallMembershipData,\n    ) {\n        if (!(data.expires || data.expires_ts)) {\n            throw new Error(\"Malformed membership: expires_ts or expires must be present\");\n        }\n        if (data.expires) {\n            if (typeof data.expires !== \"number\") {\n                throw new Error(\"Malformed membership: expires must be numeric\");\n            }\n        }\n        if (data.expires_ts) {\n            if (typeof data.expires_ts !== \"number\") {\n                throw new Error(\"Malformed membership: expires_ts must be numeric\");\n            }\n        }\n\n        if (typeof data.device_id !== \"string\") throw new Error(\"Malformed membership event: device_id must be string\");\n        if (typeof data.call_id !== \"string\") throw new Error(\"Malformed membership event: call_id must be string\");\n        if (typeof data.scope !== \"string\") throw new Error(\"Malformed membership event: scope must be string\");\n        if (!parentEvent.getSender()) throw new Error(\"Invalid parent event: sender is null\");\n    }\n\n    public get sender(): string | undefined {\n        return this.parentEvent.getSender();\n    }\n\n    public get callId(): string {\n        return this.data.call_id;\n    }\n\n    public get deviceId(): string {\n        return this.data.device_id;\n    }\n\n    public get application(): string | undefined {\n        return this.data.application;\n    }\n\n    public get scope(): CallScope {\n        return this.data.scope;\n    }\n\n    public get membershipID(): string {\n        return this.data.membershipID;\n    }\n\n    public createdTs(): number {\n        return this.data.created_ts ?? this.parentEvent.getTs();\n    }\n\n    public getAbsoluteExpiry(): number {\n        if (this.data.expires) {\n            return this.createdTs() + this.data.expires;\n        } else {\n            // We know it exists because we checked for this in the constructor.\n            return this.data.expires_ts!;\n        }\n    }\n\n    // gets the expiry time of the event, converted into the device's local time\n    public getLocalExpiry(): number {\n        if (this.data.expires) {\n            const relativeCreationTime = this.parentEvent.getTs() - this.createdTs();\n\n            const localCreationTs = this.parentEvent.localTimestamp - relativeCreationTime;\n\n            return localCreationTs + this.data.expires;\n        } else {\n            // With expires_ts we cannot convert to local time.\n            // TODO: Check the server timestamp and compute a diff to local time.\n            return this.data.expires_ts!;\n        }\n    }\n\n    public getMsUntilExpiry(): number {\n        return this.getLocalExpiry() - Date.now();\n    }\n\n    public isExpired(): boolean {\n        return this.getMsUntilExpiry() <= 0;\n    }\n\n    public getActiveFoci(): Focus[] {\n        return this.data.foci_active ?? [];\n    }\n}\n"],"mappings":"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","ignoreList":[]}